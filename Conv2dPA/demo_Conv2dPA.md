# Conv2dPA
**[DESCRIPTION]**\
&emsp;This script should help users of the Conv2dPA solution to get the first idea of how it can be applied and how the results can be interpreted.\
&emsp;We expect this solution is useful for your data analysis.\
&emsp;Please refer to (https://doi.org/********) for citation.\
**[DOWNLOAD]**\
https://github.com/V-Geler/Conv2dPA/tree/main/Conv2dPA

# 
**[Load demo data]**\
&emsp;SimuData -- Simulation HPLC-DAD measurements generated by Simulator *[(https://github.com/V-Geler/Conv2dPA/tree/main/Simulator)](https://github.com/V-Geler/Conv2dPA/tree/main/Simulator)*\
&emsp;310 retention time points, 263 spectral channels, 23 samples\
&emsp;&emsp;13 calibration samples, with 4 analytes of interest\
&emsp;&emsp;5 prediction samples, with 1 unknown interference (embedded overlap with the chromatographic peak of Analyte 4)\
&emsp;&emsp;5 spiked prediction samples, with 1 unknown interference\
&emsp;Preset parameters for the Conv2dPA project -- Comp, Info, kwargs
```
load('test/demo_simuData.mat');
```
- Please refer to *[./test/demo_simuData.txt](./test/demo_simuData.txt)* for detailed description.

#
**[Conv2dPA Fitting]**\
&emsp;function [fitConv2dPA] = v_Conv2dPA_Fitting(X_RtWlSam, Comp, Info, kwargs)
```
kwargs.verbose = true;
fitConv2dPA = v_Conv2dPA_Fitting(simuData.data, Comp, Info, kwargs);
```
- Please refer to *[./v_Conv2dPA_Fitting.txt](./v_Conv2dPA_Fitting.txt)* for detailed description.

#
**[Conv2dPA Reconstitution]**\
&emsp;function [rovConv2dPA] = v_Conv2dPA_Reconstitution(fitConv2dPA, X_RtWlSam, tarChroma, tarSpec, kwargs)
```
rovConv2dPA = v_Conv2dPA_Reconstitution(fitConv2dPA, simuData.data, Info.RefChroma, Info.RefSpec);
```
- Please refer to *[./v_Conv2dPA_Reconstitution.txt](./v_Conv2dPA_Reconstitution.txt)* for detailed description.

#
**[USEFUL VISUALIZATION]**
```
sD = simuData;
fC = fitConv2dPA;
rC = rovConv2dPA;
```
**(a) Overall visualization of [Conv2dPA] result**
```
voParam = struct();
voParam.unit = sD.axisunit;
voParam.compName = sD.compName;

voParam.title = "Conv2dPA Reconstitution"; 
v_visualizeOverall(rC.rovPf, sD.axis, [], voParam);

voParam.title = "Conv2dPA Fitting"; 
v_visualizeOverall(fC.fitPf, sD.axis, [], voParam);

clear voParam
```
**(b) Quantification analysis (Fitting vs True)**
```
pkg load statistics

idxAnalyte = 1 : 6;

aQnParam = struct('isshow', 1);
aQnParam.compName = sD.compName;
aQnParam.title = "True & Fitting";

QuanConv2dPA = v_analQuantification(sD.profileConc, fC.fitPf{3}, idxAnalyte, [], aQnParam);

clear idxAnalyte aQnParam
```
**(c) Qualification analysis (Fitting vs True)**
```
pkg load statistics

idxAnalyte = 1 : 5;

Pfref = {sD.profileChroma, sD.profileSpec, sD.profileConc};
Pfres = {fC.fitPf{1}, fC.fitPf{2}};
aQlParam = struct('isshow', 1);
aQlParam.compName = sD.compName;
aQlParam.title = "True & Fitting";
QualConv2dPA = v_analQualification(Pfref, Pfres, idxAnalyte, aQlParam);

clear idxAnalyte aQlParam
```
- **Chromatograms at characteristic wavelength, single sample**\
&emsp;Optional: 345 nm, 270 nm, 425 nm / 460 nm, 225 nm
```
sam = 14;
wl = 270;

idxwl = find(sD.axis{2} >= wl, 1);
wl = sD.axis{2}(idxwl);
ChromaTrue = sD.profileChroma(:, :, sam) .* sD.profileConc(sam, :) .* sD.profileSpec(idxwl, :);
ChromaFit = fC.fitPf{1}(:, :, sam) .* fC.fitPf{3}(sam, :) .* fC.fitPf{2}(idxwl, :, sam);

title_ = ["Chromatograms at ", num2str(wl), " ", sD.axisunit{2}, " (Sample ", num2str(sam), ")"];
figure('Name', title_, 'Position', [250 300 500 500], 'NumberTitle', 'off');
subplot(2, 1, 1); hold on
    chroma = [sum(ChromaTrue, 2), sum(ChromaFit, 2)];
    pt = plot(sD.axis{1}, chroma(:, 1), 'k', 'LineWidth', 1.5);
    pf = plot(sD.axis{1}, chroma(:, 2), 'r:', 'LineWidth', 2);
    xlim(sD.axis{1}([1, end]));
    xlabel(["Time (", sD.axisunit{1}, ")"]);
    ylim(vplot_ylimit(chroma));
    ylabel("Intensity");
    legend([pt, pf], {"True", "Fit"}, 'Location', 'northeast');
subplot(2, 1, 2); hold on
    chroma = [ChromaTrue, ChromaFit];
    pt = plot(sD.axis{1}, ChromaTrue, 'k', 'LineWidth', 1.5);
    set(gca, 'ColorOrderIndex', 1);
    pf = plot(sD.axis{1}, ChromaFit, 'LineStyle', ':', 'LineWidth', 2);
    xlim(sD.axis{1}([1, end]));
    xlabel(["Time (", sD.axisunit{1}, ")"]);
    ylim(vplot_ylimit(chroma));
    ylabel("Intensity");
    legend([pt(1), pf(1)], {"True", "Fit"}, 'Location', 'northeast');

clear sam wl idxwl ChromaTrue ChromaFit chroma pt pf title_
```
**(d) Chromatograms at characteristic wavelength (Raw Data)**\
&emsp;Optional: 345 nm, 270 nm, 425 nm / 460 nm, 225 nm
```
wl = 270;

idxwl = find(sD.axis{2} >= wl, 1);
wl = sD.axis{2}(idxwl);
title_ = ["Chromatograms at ", num2str(wl), " ", sD.axisunit{2}];
figure('Name', title_, 'Position', [250 400 600 300], 'NumberTitle', 'off');
    plot(sD.axis{1}, squeeze(sD.data(:, idxwl, :)), 'LineWidth', 1.5);
    set(gca, 'ColorOrder', jet(sD.DimX(3)));
    xlabel(["Time (", sD.axisunit{1}, ")"]);
    xlim(sD.axis{1}([1, end]));
    ylabel("Intensity");
    ylim(vplot_ylimit(sD.data(:, idxwl, :)));
    title("Raw Data");
    
clear wl idxwl title_
```
#